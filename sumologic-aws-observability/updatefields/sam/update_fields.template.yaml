AWSTemplateFormatVersion: '2010-09-09'
Transform: 'AWS::Serverless-2016-10-31'
Description: "Template to add fields for existing Sources in Sumo Logic for AWS Observability Solution."

Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: "Sumo Logic Access Configuration (Required)"
        Parameters:
          - SumoDeployment
          - SumoAccessID
          - SumoAccessKey
          - RemoveSumoResourcesOnDeleteStack

      - Label:
          default: "AWS Resources Tag Configuration (Required)"
        Parameters:
          - AccountAlias

      - Label:
          default: "AWS ALB App Configuration"
        Parameters:
          - CreateELBLogSource
          - AlbS3LogsCollectorName
          - AlbELBLogsSourceName

      - Label:
          default: "AWS DynamoDB App Configuration"
        Parameters:
          - CreateDynamoDBCloudTrailLogSource
          - DynamoDBCloudTrailCollectorName
          - DynamoDBCloudTrailLogsSourceName

      - Label:
          default: "AWS Api Gateway App Configuration"
        Parameters:
          - CreateApiGatewayCloudTrailLogSource
          - ApiGatewayCloudTrailCollectorName
          - ApiGatewayCloudTrailLogsSourceName

      - Label:
          default: "AWS Lambda App Configuration"
        Parameters:
          - CreateLambdaCloudTrailLogSource
          - LambdaCloudTrailCollectorName
          - LambdaCloudTrailLogsSourceName
          - CreateLambdaCloudWatchLogsSource
          - LambdaCloudWatchLogsCollectorName
          - LambdaCloudWatchLogsSourceName

      - Label:
          default: "Local Parameters. Do Not Edit the values."
        Parameters:
          - ParentStackName

    ParameterLabels:
      SumoDeployment:
        default: "Sumo Logic Deployment Name"
      SumoAccessID:
        default: "Sumo Logic Access ID"
      SumoAccessKey:
        default: "Sumo Logic Access Key"
      RemoveSumoResourcesOnDeleteStack:
        default: "Delete Sumo Logic Resources when stack is deleted"

      AccountAlias:
        default: "Alias for AWS Account Identification"

      CreateELBLogSource:
        default: "Create Sumo Logic ELB Logs Source"
      AlbS3LogsCollectorName:
        default: "Sumo Logic ALB S3 Logs Collector Name"
      AlbELBLogsSourceName:
        default: "Sumo Logic ALB ELB Logs Source Name"

      CreateDynamoDBCloudTrailLogSource:
        default: "Create Sumo Logic CloudTrail Logs Source"
      DynamoDBCloudTrailCollectorName:
        default: "Sumo Logic Dynamo DB CloudTrail Logs Collector Name"
      DynamoDBCloudTrailLogsSourceName:
        default: "Sumo Logic Dynamo DB CloudTrail Logs Source Name"

      CreateLambdaCloudTrailLogSource:
        default: "Create Sumo Logic CloudTrail Logs Source"
      LambdaCloudTrailCollectorName:
        default: "Sumo Logic Lambda CloudTrail Logs Collector Name"
      LambdaCloudTrailLogsSourceName:
        default: "Sumo Logic Lambda CloudTrail Logs Source Name"
      CreateLambdaCloudWatchLogsSource:
        default: "Create Sumo Logic CloudWatch Logs Source"
      LambdaCloudWatchLogsCollectorName:
        default: "Sumo Logic Lambda CloudWatch Logs Collector Name"
      LambdaCloudWatchLogsSourceName:
        default: "Sumo Logic Lambda CloudWatch Logs Source Name"

      CreateApiGatewayCloudTrailLogSource:
        default: "Create Sumo Logic CloudTrail Logs Source"
      ApiGatewayCloudTrailCollectorName:
        default: "Sumo Logic Api Gateway CloudTrail Logs Collector Name"
      ApiGatewayCloudTrailLogsSourceName:
        default: "Sumo Logic Api Gateway CloudTrail Logs Source Name"

      ParentStackName:
        default: "If Any, Name of parent Stack"

Parameters:
  SumoDeployment:
    Type: String
    AllowedValues:
      - au
      - ca
      - de
      - eu
      - jp
      - us2
      - us1
      - in
      - fed
    Description: "Enter au, ca, de, eu, jp, us2, in, fed or us1."
  SumoAccessID:
    Type: String
    Description: The Sumo Logic Access ID.
    AllowedPattern: ".+"
  SumoAccessKey:
    Type: String
    Description: The Sumo Logic Access Key.
    AllowedPattern: ".+"
    NoEcho: true
  RemoveSumoResourcesOnDeleteStack:
    AllowedValues:
      - true
      - false
    Default: true
    Description: To delete collector, sources and app when stack is deleted, set this parameter to true. Default is true.
    Type: String


  AccountAlias:
    Type: String
    Description: "Provide an Alias for AWS account for identification in Sumo Logic Explorer View, metrics and logs. Please do not include special characters."
    AllowedPattern: "[a-zA-Z0-9]+"

  CreateELBLogSource:
    Type: String
    Description: "Yes -> To create Sumo Logic ELB Log Source which collect ALB logs from an existing bucket or a new bucket. Default Name - sumologic-aws-observability-alb-s3-logs.
                  No -> If you already have an ELB Source collecting ALB logs into Sumo Logic."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  AlbS3LogsCollectorName:
    Type: String
    Description: "Required when Flag = No. Provide ALB app existing collector name from Sumo Logic."
    Default: ""
  AlbELBLogsSourceName:
    Type: String
    Description: "Required when Flag = No. Provide ALB app existing source name from Sumo Logic. account, region and namespace Fields will be added."
    Default: ""

  CreateDynamoDBCloudTrailLogSource:
    Type: String
    Description: "Yes -> To create Sumo Logic CloudTrail Log Source which collect DynamoDB logs from an existing bucket or a new bucket. Default Name - sumologic-aws-observability-cloudtrail-logs.
                  No -> If you already have an CloudTrail Log source collecting DynamoDB logs into Sumo Logic."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  DynamoDBCloudTrailCollectorName:
    Type: String
    Description: "Required when Flag = No. Provide DynamoDB app existing collector name from Sumo Logic."
    Default: ""
  DynamoDBCloudTrailLogsSourceName:
    Type: String
    Description: "Required when Flag = No. Provide DynamoDB app existing source name from Sumo Logic. account, region and namespace Fields will be added."
    Default: ""

  CreateLambdaCloudTrailLogSource:
    Type: String
    Description: "Yes -> To create Sumo Logic CloudTrail Log Source which collect DynamoDB logs from an existing bucket or a new bucket. Default Name - sumologic-aws-observability-cloudtrail-logs.
                 No -> If you already have an CloudTrail Log source collecting DynamoDB logs into Sumo Logic."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  LambdaCloudTrailCollectorName:
    Type: String
    Description: "Required when Flag = No. Provide Lambda app existing collector name from Sumo Logic."
    Default: ""
  LambdaCloudTrailLogsSourceName:
    Type: String
    Description: "Required when Flag = No. Provide Lambda app existing source name from Sumo Logic. account, region and namespace Fields will be added."
    Default: ""
  CreateLambdaCloudWatchLogsSource:
    Type: String
    Description: "Yes -> To create Sumo Logic CloudWatch Log Source which collect Lambda logs from AWS. Default Name - sumologic-aws-observability-cloudwatch-logs.
                  No -> If you already have an CloudWatch Log source collecting Lambda logs into Sumo Logic."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  LambdaCloudWatchLogsCollectorName:
    Type: String
    Description: "Required when Flag = No. Provide Lambda app existing CloudWatch logs collector name from Sumo Logic."
    Default: ""
  LambdaCloudWatchLogsSourceName:
    Type: String
    Description: "Required when Flag = No. Provide Lambda app existing CloudWatch logs source name from Sumo Logic. account, region and namespace Fields will be added."
    Default: ""

  CreateApiGatewayCloudTrailLogSource:
    Type: String
    Description: "Yes -> To create Sumo Logic CloudTrail Log Source which collect API Gateway logs from an existing bucket or a new bucket. Default Name - sumologic-aws-observability-cloudtrail-logs.
                 No -> If you already have an CloudTrail Log source collecting API Gateway logs into Sumo Logic."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  ApiGatewayCloudTrailCollectorName:
    Type: String
    Description: "Required when Flag = No. Provide API Gateway app existing collector name from Sumo Logic."
    Default: ""
  ApiGatewayCloudTrailLogsSourceName:
    Type: String
    Description: "Required when Flag = No. Provide API Gateway app existing source name from Sumo Logic. account, region and namespace Fields will be added."
    Default: ""

  ParentStackName:
    Type: String
    Default: "ParentStackName"
    Description: Parent Stack Name. Do Not Edit the value.

Mappings:
  RegionMap:
    us-east-1:
      bucketname: appdevzipfiles-us-east-1
    us-east-2:
      bucketname: appdevzipfiles-us-east-2
    us-west-1:
      bucketname: appdevzipfiles-us-west-1
    us-west-2:
      bucketname: appdevzipfiles-us-west-2
    ap-south-1:
      bucketname: appdevzipfiles-ap-south-1
    ap-northeast-2:
      bucketname: appdevzipfiles-ap-northeast-2
    ap-southeast-1:
      bucketname: appdevzipfiles-ap-southeast-1
    ap-southeast-2:
      bucketname: appdevzipfiles-ap-southeast-2
    ap-northeast-1:
      bucketname: appdevzipfiles-ap-northeast-1
    ca-central-1:
      bucketname: appdevzipfiles-ca-central-1
    eu-central-1:
      bucketname: appdevzipfiles-eu-central-1
    eu-west-1:
      bucketname: appdevzipfiles-eu-west-1
    eu-west-2:
      bucketname: appdevzipfiles-eu-west-2
    eu-west-3:
      bucketname: appdevzipfiles-eu-west-3
    eu-north-1:
      bucketname: appdevzipfiles-eu-north-1s
    sa-east-1:
      bucketname: appdevzipfiles-sa-east-1

Conditions:
  do_not_use_parent_stack: !Equals [ !Ref ParentStackName, "ParentStackName"]
  update_alb_source: !Equals [ !Ref CreateELBLogSource, "No"]
  update_dynamodb_source: !Equals [ !Ref CreateDynamoDBCloudTrailLogSource, "No"]
  update_api_gateway_source: !Equals [ !Ref CreateApiGatewayCloudTrailLogSource, "No"]
  update_lambda_cloudtrail_source: !Equals [ !Ref CreateLambdaCloudTrailLogSource, "No"]
  update_lambda_cloudwatch_source: !Equals [ !Ref CreateLambdaCloudWatchLogsSource, "No"]

Resources:

  WaitHandle:
    Type: "AWS::CloudFormation::WaitConditionHandle"

  SumoLogicHelperRole:
    Type: AWS::IAM::Role
    Condition: do_not_use_parent_stack
    Properties:
      RoleName : !Join
        - ""
        - - !Sub "sumo-lambda-role-${AccountAlias}-"
          - !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split ["/", !Ref "AWS::StackId"]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: AwsObservabilityLambdaExecutePolicies
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                  - cloudtrail:CreateTrail
                  - cloudtrail:DeleteTrail
                  - cloudtrail:UpdateTrail
                  - cloudtrail:StartLogging
                Resource: '*'

  SumoLogicHelperFunction:
    Type: 'AWS::Serverless::Function'
    DependsOn: SumoLogicHelperRole
    Condition: do_not_use_parent_stack
    Properties:
      FunctionName: !Join
        - ""
        - - !Sub "sumo-lambda-${AccountAlias}-"
          - !Select
            - 0
            - !Split
              - "-"
              - !Select
                - 2
                - !Split ["/", !Ref "AWS::StackId"]
      Handler: main.handler
      Runtime: python3.7
      CodeUri:
        Bucket: !FindInMap [RegionMap, !Ref 'AWS::Region', bucketname]
        Key: !Sub "sumologic-aws-observability/SumoLogicAWSObservabilityHelper/SumoLogicAWSObservabilityHelper.zip"
      MemorySize: 128
      Timeout: 900
      Role:
        Fn::GetAtt:
          - SumoLogicHelperRole
          - Arn

  SumoALBHostedCollector:
    Type: Custom::Collector
    Condition: update_alb_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      CollectorType: Hosted
      RemoveOnDeleteStack: false
      CollectorName: !Ref AlbS3LogsCollectorName
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment

  SumoALBSource:
    Type: Custom::SumoLogicUpdateFields
    Condition: update_alb_source
    DependsOn: SumoALBHostedCollector
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      SourceName: !Ref AlbELBLogsSourceName
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      CollectorId: !GetAtt SumoALBHostedCollector.COLLECTOR_ID
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment
      Fields:
        account: !Ref AccountAlias
        namespace: "AWS/ApplicationELB"
        region: !Ref "AWS::Region"

  DynamoDBWaitHandle:
    Condition: update_alb_source
    DependsOn: SumoALBSource
    Type: "AWS::CloudFormation::WaitConditionHandle"

  DynamoDBWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [update_alb_source, !Ref DynamoDBWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  SumoDynamoDBHostedCollector:
    Type: Custom::Collector
    Condition: update_dynamodb_source
    DependsOn: DynamoDBWaitCondition
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      CollectorType: Hosted
      RemoveOnDeleteStack: false
      CollectorName: !Ref DynamoDBCloudTrailCollectorName
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment

  SumoDynamoDBSource:
    Type: Custom::SumoLogicUpdateFields
    DependsOn: SumoDynamoDBHostedCollector
    Condition: update_dynamodb_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      SourceName: !Ref DynamoDBCloudTrailLogsSourceName
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      CollectorId: !GetAtt SumoDynamoDBHostedCollector.COLLECTOR_ID
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment
      Fields:
        account: !Ref AccountAlias

  ApiGatewayWaitHandle:
    Condition: update_dynamodb_source
    DependsOn: SumoDynamoDBSource
    Type: "AWS::CloudFormation::WaitConditionHandle"

  ApiGatewayWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [update_dynamodb_source, !Ref ApiGatewayWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  SumoApiGatewayHostedCollector:
    Type: Custom::Collector
    DependsOn: ApiGatewayWaitCondition
    Condition: update_api_gateway_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      CollectorType: Hosted
      RemoveOnDeleteStack: false
      CollectorName: !Ref ApiGatewayCloudTrailCollectorName
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment

  SumoApiGatewaySource:
    Type: Custom::SumoLogicUpdateFields
    DependsOn: SumoApiGatewayHostedCollector
    Condition: update_api_gateway_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      SourceName: !Ref ApiGatewayCloudTrailLogsSourceName
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      CollectorId: !GetAtt SumoApiGatewayHostedCollector.COLLECTOR_ID
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment
      Fields:
        account: !Ref AccountAlias

  LambdaCloudTrailWaitHandle:
    Condition: update_api_gateway_source
    DependsOn: SumoApiGatewaySource
    Type: "AWS::CloudFormation::WaitConditionHandle"

  LambdaCloudTrailWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [update_api_gateway_source, !Ref LambdaCloudTrailWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  SumoLambdaCloudTrailHostedCollector:
    Type: Custom::Collector
    DependsOn: LambdaCloudTrailWaitCondition
    Condition: update_lambda_cloudtrail_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      CollectorType: Hosted
      RemoveOnDeleteStack: false
      CollectorName: !Ref LambdaCloudTrailCollectorName
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment

  SumoLambdaCloudTrailSource:
    Type: Custom::SumoLogicUpdateFields
    DependsOn: SumoLambdaCloudTrailHostedCollector
    Condition: update_lambda_cloudtrail_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      SourceName: !Ref LambdaCloudTrailLogsSourceName
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      CollectorId: !GetAtt SumoLambdaCloudTrailHostedCollector.COLLECTOR_ID
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment
      Fields:
        account: !Ref AccountAlias

  LambdaCloudWatchWaitHandle:
    Condition: update_lambda_cloudtrail_source
    DependsOn: SumoLambdaCloudTrailSource
    Type: "AWS::CloudFormation::WaitConditionHandle"

  LambdaCloudWatchWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [update_lambda_cloudtrail_source, !Ref LambdaCloudWatchWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  SumoLambdaCloudWatchHostedCollector:
    Type: Custom::Collector
    DependsOn: LambdaCloudWatchWaitCondition
    Condition: update_lambda_cloudwatch_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      CollectorType: Hosted
      RemoveOnDeleteStack: false
      CollectorName: !Ref LambdaCloudWatchLogsCollectorName
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment

  SumoLambdaCloudWatchSource:
    Type: Custom::SumoLogicUpdateFields
    DependsOn: SumoLambdaCloudWatchHostedCollector
    Condition: update_lambda_cloudwatch_source
    Properties:
      ServiceToken: !If
        - do_not_use_parent_stack
        - !GetAtt
          - SumoLogicHelperFunction
          - Arn
        - !ImportValue
          'Fn::Sub': '${ParentStackName}-SumoLogicHelperFunctionARN'
      Region: !Ref "AWS::Region"
      SourceName: !Ref LambdaCloudWatchLogsSourceName
      RemoveOnDeleteStack: !Ref RemoveSumoResourcesOnDeleteStack
      CollectorId: !GetAtt SumoLambdaCloudWatchHostedCollector.COLLECTOR_ID
      SumoAccessID: !Ref SumoAccessID
      SumoAccessKey: !Ref SumoAccessKey
      SumoDeployment: !Ref SumoDeployment
      Fields:
        account: !Ref AccountAlias
        namespace: "aws/lambda"
        region: !Ref "AWS::Region"